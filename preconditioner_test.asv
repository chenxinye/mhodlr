n = 100;

A = rand(n, n);
disp(cond(A, 2));


%$ working precision
epsilon = 0.00001;
hA = hodlr(A, 5, 20, 'svd', epsilon);

hh = hdot(hA.transpose(), hA, 'hodlr')
R = hchol(hh, 'hodlr');
rR = recover(R);
rR * rR - recover
% RA = recover(hA);
% disp(norm(RA - A, 'fro'));
disp('Working precision, eps=0.001')
P = hpcond(hA, epsilon); % input a HODLR matrix
disp(cond(P*A, 2)); % condition number is about 1

disp('Working precision, eps=0.01')
epsilon = 0.01;
P = hpcond(A, epsilon); % input a default matrix which will be automatically 
                        % converted into HODLR matrix
                        
disp(cond(P*A, 2)); % condition number decrease


%% mix precision
u1 = precision('q43');
u2 = precision('q43');
u3 = precision('q43');
u4 = precision('h');
u5 = precision('h');
u_chain = prec_chain(u1, u2, u3, u4, u5);

disp('Precision [q43, q43, q43, h, h], eps=0.001')
epsilon = 0.001;
hA = mphodlr(u_chain, A, 5, 20, 'svd', epsilon);
% RA = recover(hA);
% disp(norm(RA - A, 'fro'));
P = mphpcond(hA, u_chain, epsilon); % input a HODLR matrix
disp(cond(P*A, 2)); % condition number is about 1

disp('Precision [q43, q43, q43, h, h], eps=0.01')
epsilon = 0.01;
hA = mphodlr(u_chain, A, 5, 20, 'svd', epsilon);
P = mphpcond(hA, u_chain, epsilon); % input a HODLR matrix
disp(cond(P*A, 2)); % condition number decrease

